#!/bin/bash

DOCKER_IMAGE_TAG="${BUILDBOX_PROJECT_SLUG}:${BUILDBOX_BUILD_ID}"

echo -e "--- build rspec runner image: ${DOCKER_IMAGE_TAG}"
docker build --tag=$DOCKER_IMAGE_TAG .

# Default number of containers to number of processors
if [ ! "$DOCEPTION_CONTAINERS" ]
then
    DOCEPTION_CONTAINERS=`nproc`
fi

PWD=`readlink -f .`
opts="-v ${PWD}:/srv/application -w /srv/application ${DOCKER_IMAGE_TAG}"

# Bundle the gems
docker $opts bundle install --verbose --deployment -j $DOCEPTION_CONTAINERS

echo -e "+++ initiate parallel spec run with ${DOCEPTION_CONTAINERS}"
#for i in $(seq 1 $DOCEPTION_CONTAINERS); do
#    echo -e "\tStarting container #${i}"
#    find spec -iname "*_spec.rb" | /usr/bin/parallel -X docker $opts bundle exec rspec
#done
find spec -iname "*_spec.rb" | /usr/bin/parallel -X docker $opts bundle exec rspec
