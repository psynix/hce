#!/bin/bash

DOCKER_IMAGE_TAG="${BUILDBOX_PROJECT_SLUG}:${BUILDBOX_BUILD_ID}"

echo -e "--- build rspec runner image: ${DOCKER_IMAGE_TAG}"
docker build --tag=$DOCKER_IMAGE_TAG .

# Default number of containers to number of processors
if [ ! "$DOCEPTION_CONTAINERS" ]
then
    DOCEPTION_CONTAINERS=`nproc`
fi

echo -e "+++ initiate parallel spec run with ${DOCEPTION_CONTAINERS}"
for i in $(seq 1 $DOCEPTION_CONTAINERS); do
    echo -e "\tStarting container #${i}"
    docker run $DOCKER_IMAGE_TAG echo "Hello from sub-container #{$i}"
done
